<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" /> 
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.3/openlocationcode.js"></script>
	<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

	<style>
		html, body {
			height: 100%;
			margin: 0px;
		}
		#map-header {
			height: 40px;
			margin-left: 15px;
			margin-right: 15px;
			display: flex;
		}
		#map {
			position: absolute;
			top:50px;
			left:0px;
			right:0px;
			bottom: 10px;
			width: 100%;
		}
	</style>
</head>
<body>

<div id='map-header'>
	<h3 id='map-header-text'>Map of places: <span id="map-info">zooming to get data</span></h3>
</div>
<div id='map'>		
</div>
<!-- https://github.com/makinacorpus/Leaflet.RestoreView/blob/master/leaflet.restoreview.js -->
<script>
	(function() {
    var RestoreViewMixin = {
        restoreView: function () {
            if (!storageAvailable('localStorage')) {
                return false;
            }
            var storage = window.localStorage;
            if (!this.__initRestore) {
                this.on('moveend', function (e) {
                    if (!this._loaded)
                        return;  // Never access map bounds if view is not set.

                    var view = {
                        lat: this.getCenter().lat,
                        lng: this.getCenter().lng,
                        zoom: this.getZoom()
                    };
                    storage['mapView'] = JSON.stringify(view);
                }, this);
                this.__initRestore = true;
            }

            var view = storage['mapView'];
            try {
                view = JSON.parse(view || '');
                this.setView(L.latLng(view.lat, view.lng), view.zoom, true);
                return true;
            }
            catch (err) {
                return false;
            }
        }
    };

    function storageAvailable(type) {
        try {
            var storage = window[type],
                x = '__storage_test__';
            storage.setItem(x, x);
            storage.removeItem(x);
            return true;
        }
        catch(e) {
            console.warn("Your browser blocks access to " + type);
            return false;
        }
    }

    L.Map.include(RestoreViewMixin);
})();
</script>

<script>
	
	var map = L.map('map');
	var currentLayer = null;
	var currentBounds = {};
	var placesCache = {};
	if (!map.restoreView()) {
        map.setView([40, -35], 4);
    }

	L.tileLayer('https://tile.osmand.net/{z}/{x}/{y}.png', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ',
		id: 'tiles'
	}).addTo(map);


	function onEachFeature(feature, layer) {
		var p = feature.properties;
		var popupContent = "<b>" + p.osm_value + "</b> (" + p.opr_id+") ";

		for (var t in p.tags) {
			popupContent += "<br>" + t + " " + p.tags[t];
		}
		popupContent += "<br><a href=\'/api/admin?view=objects&browse=type&type=opr.place&subtype=id&key=" +
			p.opr_id + "\'>OpenPlaceReviews</a>";
		popupContent += "<br><a href=\'https://www.openstreetmap.org/" +
			p.type + "/" + p.id + "\'>OpenStreetMap</a>";
		
		layer.bindPopup(popupContent);
	}

	function calculateLocationCodes(bounds) {
		var tl = OpenLocationCode.encode(bounds.getNorth(), bounds.getWest(), 6);
		var rb = OpenLocationCode.encode(bounds.getSouth(), bounds.getEast(), 6);
		var INT_PR = 20;
		var tllat = Math.ceil(bounds.getNorth() * INT_PR);
		var tllon = Math.floor(bounds.getWest() * INT_PR);
		var brlat = Math.floor(bounds.getSouth() * INT_PR);
		var brlon = Math.ceil(bounds.getEast() * INT_PR);
		var mp = {};
		for (var lat = tllat; lat > brlat; lat --) {
			for (var lon = tllon; lon < brlon; lon ++) {
				var clat = (lat - 0.5) / INT_PR ;
				var clon = (lon + 0.5) / INT_PR ;
				var tileId = OpenLocationCode.encode(clat, clon, 6).substring(0, 6);
				mp[tileId] = {};
			}
		}
		return mp;
	}

	function refreshMap() {
		
		if (currentLayer) {
			map.removeLayer(currentLayer);
			// currentLayer.remove();
		}
		var geoJson = { 
   			"type":"FeatureCollection",
			"features":[]
		};
		var tiles = 0;
		var missing = 0;
		for(var k in currentBounds) {
			var cTileId = placesCache[k];
			if("features" in cTileId) {
				tiles++;
				geoJson.features = geoJson.features.concat(cTileId.features);
			} else {
				missing++;
			}
		}
		var msg = tiles + " tiles have " + geoJson.features.length + " places " ;
		if(missing > 0) {
			msg += " (" + missing + " tiles loading...) ";
		}
		$("#map-info").text(msg);
		currentLayer = L.markerClusterGroup();
		let currentLayerPoints = L.geoJSON(geoJson , {
			style: function (feature) {
				return feature.properties && feature.properties.style;
			},
			onEachFeature: onEachFeature,
			pointToLayer: function (feature, latlng) {
				return L.circleMarker(latlng, {
					radius: 8,
					fillColor: "#ff7800",
					color: "#000",
					weight: 1,
					opacity: 1,
					fillOpacity: 0.8
				});
			}
		});
		currentLayer.addLayer(currentLayerPoints);
		// currentLayer.addTo(map);
		map.addLayer(currentLayer);
	}

	function onMapChange() {
		var bounds = map.getBounds();
		var lcodes = calculateLocationCodes(bounds);
		var elcodes = JSON.stringify(lcodes);
		var tl = OpenLocationCode.encode(bounds.getNorth(), bounds.getWest(), 6);
		var rb = OpenLocationCode.encode(bounds.getSouth(), bounds.getEast(), 6);
		if(map.getZoom() <= 10) {
			$("#map-info").text("zooming to get data ");
		} else if(elcodes != JSON.stringify(currentBounds) ) {
			currentBounds = lcodes;
			var tilesToLoad = {};
			for(var t in lcodes) {
				let tileId = t;
				if(!placesCache[tileId]) {
					placesCache[tileId] = {};
					// on failure we can clear cache
					$.getJSON("data?tileid=" + tileId, function (data) {
						placesCache[tileId] = data;
						refreshMap();
					});
				}
			}
			refreshMap();
		}
	}

	map.on('moveend', function (e) {
		onMapChange();
	});
	onMapChange();


</script>


</body>
</html>