<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />


	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" /> 
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.0/css/bootstrap.min.css">

	<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.3/openlocationcode.js"></script>
	<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.0/js/bootstrap.min.js"></script>
    
	<style>
		html, body {
			height: 100%;
		}
		#map-header {
			margin-top: 5px;
			margin-left: 5px;
		}
		#map {
			position: absolute;
			top:50px;
			left:0px;
			right:0px;
			bottom: 10px;
			width: 100%;
		}
	</style>
</head>
<body>
	<div id='map-header' class="form-row align-items-center">
		<div class="col-2">
			<input class="form-control d-none" type="date" id="date-filter">
			<select id="filter" class="form-control d-none">
					<option selected value="all">Filter...</option>
			</select>
		</div>
		<div>
			<span id='map-header-text'></span>
		</div>
	</div>
	<div id='map'>
	</div>
<!-- https://github.com/makinacorpus/Leaflet.RestoreView/blob/master/leaflet.restoreview.js -->
<script>
		(function() {
		var RestoreViewMixin = {
			restoreView: function () {
				if (!storageAvailable('localStorage')) {
					return false;
				}
				var storage = window.localStorage;
				if (!this.__initRestore) {
					this.on('moveend', function (e) {
						if (!this._loaded)
							return;  // Never access map bounds if view is not set.
	
						var view = {
							lat: this.getCenter().lat,
							lng: this.getCenter().lng,
							zoom: this.getZoom()
						};
						storage['mapView'] = JSON.stringify(view);
					}, this);
					this.__initRestore = true;
				}
	
				var view = storage['mapView'];
				try {
					view = JSON.parse(view || '');
					this.setView(L.latLng(view.lat, view.lng), view.zoom, true);
					return true;
				}
				catch (err) {
					return false;
				}
			}
		};
	
		function storageAvailable(type) {
			try {
				var storage = window[type],
					x = '__storage_test__';
				storage.setItem(x, x);
				storage.removeItem(x);
				return true;
			}
			catch(e) {
				console.warn("Your browser blocks access to " + type);
				return false;
			}
		}
	
		L.Map.include(RestoreViewMixin);
	})();
</script>

<script>
	var map = L.map('map');
	var currentLayer;

	function getMarkerContent(feature) {
		var p = feature.properties;
		//var typeName = types? types[p.osm_value] : null;
		// if(!typeName) {
		// var typeName = p.osm_value;
		// }
		// var name = p.tags["name"];
		var popupContent = p.title;
		if(p.opr_id) {
			popupContent += " (" + p.opr_id+") ";
		}
		if (p.hasOwnProperty("title") && p.title === "Edited") {
		    if (p.prev) {
		        for (let prev in p.prev) {
                    if (prev === "tags") {
                        for (let t in p.prev.tags) {
                            popupContent += "<br>prev.tags." + t + " " + p.prev.tags[t];
                        }
                    } else {
                        popupContent += "<br>prev." + prev + " " + p.prev[prev];
                    }
                }
			}
			if (p.next) {
                for (let next in p.next) {
                    if (next === "tags") {
                        for (let t in p.next.tags) {
                            popupContent += "<br>next.tags." + t + " " + p.next.tags[t];
                        }
                    } else {
                        popupContent += "<br>next." + next + " " + p.next[next];
                    }
                }
			}
		}
		if(p.tags) {
			for (var t in p.tags) {
				popupContent += "<br>" + t + " " + p.tags[t];
			}
		}
		if(p.opr_id) {
			popupContent += "<br><a href=\'/api/admin?view=objects&browse=type&type=opr.place&subtype=id&key=" +
				p.opr_id + "\'>OpenPlaceReviews</a>";
		}
		if(p.osm_id) {
			popupContent += "<br><a href=\'https://www.openstreetmap.org/" +
				p.osm_type + "/" + p.osm_id + "\'>OpenStreetMap</a>";
		}
		return popupContent;
	}
	
	function refreshData() {
		$("#map-header-text").text("Loading data...");
		if (currentLayer) {
			map.removeLayer(currentLayer);
			// currentLayer.remove();
		}
		$.getJSON("data?date=" + $("#date-filter").val(), function (mp) {
			let data = mp.geo;
			$("#map-header-text").text("Loaded " + data.features.length + " objects");
			currentLayer = L.markerClusterGroup();
			let currentLayerPoints = L.geoJSON(data, {
				style: function (feature) {
					return feature.properties && feature.properties.style;
				},

				pointToLayer: function (feature, latlng) {
					return L.marker(latlng, {icon: getColor(feature)}).bindPopup(getMarkerContent(feature));
					// return L.circleMarker(latlng, {
					// 	radius: 8,
					// 	fillColor: "#ff7800",
					// 	color: "#000",
					// 	weight: 1,
					// 	opacity: 1,
					// 	fillOpacity: 0.8
					// });
				}
			});
			currentLayer.addLayer(currentLayerPoints);
			// currentLayer.addTo(map);
			map.addLayer(currentLayer);
		});
	}
	
	if (!map.restoreView()) {
        map.setView([40, -35], 4);
	}
	L.tileLayer('https://tile.osmand.net/{z}/{x}/{y}.png', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ',
		id: 'tiles'
	}).addTo(map);

	refreshData();
	$("#date-filter").removeClass("d-none");
	$("#date-filter").change(function(){
		refreshData();
	});

	function getColor(feature) {
        var color = getBlueColor();
        if (feature.properties.hasOwnProperty("title")) {
            switch (feature.properties.title) {
                case "Created": {
                    color = getGreenColor();
                    break;
                }
                case "Removed": {
                    color = getRedColor();
                    break;
                }
            }
        }
        return color;
    }

	function getGreenColor() {
		return new L.Icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    function getBlueColor() {
        return new L.Icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    function getRedColor() {
        return new L.Icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }
</script>


</body>
</html>