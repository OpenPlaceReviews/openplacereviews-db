<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/api/images/favicon.ico" />

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="/api/css/mapall.css" />


	<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.3/openlocationcode.js"></script>
	<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.0/js/bootstrap.min.js"></script>
	<script src="/api/js/sidenav.js"></script>
</head>
<body>

	<div id="mySidenav" class="sidenav">
		<a href="javascript:void(0)" class="closebtn sidenavA" onclick="closeNav()">&times;</a>
		<h2 id="placeName" class="remove-element-top-bot-spaces"></h2>
		<p id="placeType"></p>
		<br>
		<p><b>ID:</b> <a id="placeId" href="">23dfd</a></p>
		<p><b>Location:</b> <span id="placeLocation">12.2323,12.43445</span></p>
		<div class="table-responsive custom-table">
			<table class="table table-bordered browse-tag-list" id="opendb-table-tags">
				<tbody id="opendb-tag-table">
				</tbody>

				<tbody class="display-none">
				<tr id="img-tag-template">
					<th class="browse-tag-k"><img did="image-tag-k" width="20" height="20"> <a did="tag-k"></a></th>
					<td class="browse-tag-v word-wrap-break-word" did="tag-v"></td>
				</tr>
				</tbody>
			</table>
		</div>
		<hr>
		<div class="wrapper center-block">
			<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
				<div class="panel panel-default">
					<div class="panel-heading" role="tab" id="headingOne">
						<h4 class="panel-title">
							<a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
								<img height="30" width="30" src="/api/images/openStreetMap.png">
								<span>OpenStreetMap</span>
								<p><span id="osmId" href></span>  &#8226 <span id="osmTagsAmount"></span> tags</p>
							</a>
						</h4>
					</div>
					<div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
						<div class="panel-body">
							<p><b>Version: </b>#<span id="osmVersion">4</span> &mdash; <b>Changeset </b><a id="placeChangeset" href="">#23423423</a></p>
							<p><b>Location:</b> <span id="osmLocation">12.2323,12.43445</span></p>
							<div class="table-responsive custom-table">
								<table class="table table-bordered browse-tag-list" id="osm-table-tags">
									<tbody id="osm-tag-table">
									</tbody>

									<tbody class="display-none">
									<tr id="tag-template">
										<th class="browse-tag-k"><a did="tag-k"></a></th>
										<td class="browse-tag-v word-wrap-break-word" did="tag-v"></td>
									</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
				<div class="panel panel-default">
					<div class="panel-heading" role="tab" id="headingTwo">
						<h4 class="panel-title">
							<a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
								<img  height="30" width="30" src="/api/images/trip-advisor.png">
								<span>TripAdvisor</span>
								<p><span id="tripadvisorId"></span> <!--&#8226 <span id="TripAdvisorTagsAmount">&#9733&#9733&#9733</span>(<span id="TripAdvisorReviews">123</span>)--></p>
							</a>
						</h4>
					</div>
					<div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
						<div class="panel-body">
							<div class="hidden" id="missing-tripadvisor">
								<p>Missing ID <a id="tripadvisor-link" href="" target="_blank"></a></p>
							</div>
							<div class="form-group margin-top-style hidden" id="trip-advisor-add-block">
								<div class="row margin-left-style margin-right-style">
									<input type="text" id="tripAdvisorURL" class="form-control">
								</div>
								<button id="add-trip-advisor" class="btn btn-default margin-left-style margin-top-style"><img height="20" width="20" src="/api/images/trip-advisor.png"> Add TripAdvisor Link</button>
							</div>
							<div id="tripadvisor-exist-div" class="form-group margin-top-style hidden">
								<div class="row margin-left-style margin-right-style">
									<a id="tripadv-successfull" href=""></a>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!--<div class="panel panel-default">-->
					<!--<div class="panel-heading" role="tab" id="headingThree">-->
						<!--<h4 class="panel-title">-->
							<!--<a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">-->
								<!--<span>Photos</span>-->
							<!--</a>-->
						<!--</h4>-->
					<!--</div>-->
					<!--<div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">-->
						<!--<div class="panel-body">-->
							<!--&lt;!&ndash;TODO update photos viewer&ndash;&gt;-->
							<!--<div class="margin-left-style form-inline">-->
								<!--<div class="column">-->
									<!--<img src="/api/images/trip-advisor.png" alt="Snow" class="style-with-20">-->
								<!--</div>-->
								<!--<div class="column">-->
									<!--<img src="/api/images/trip-advisor.png" alt="Forest" class="style-with-20">-->
								<!--</div>-->
								<!--<div class="column">-->
									<!--<img src="/api/images/trip-advisor.png" alt="Mountains" class="style-with-20">-->
								<!--</div>-->
							<!--</div>-->
							<!--<div class="form-group margin-top-style">-->
								<!--<button class="btn btn-default margin-left-style remove-border"><img height="20" width="20" src="/api/images/plus-icon.jpg"> Add Photos</button>-->
								<!--<hr class="margin-left-style margin-right-style remove-element-top-bot-spaces">-->
								<!--<button class="btn btn-default margin-left-style remove-border"><img height="20" width="20" src="/api/images/mapillary.png"> Connect to Mapillary</button>-->
							<!--</div>-->
						<!--</div>-->
					<!--</div>-->
				<!--</div>-->
				<!--<div class="panel panel-default">-->
					<!--<div class="panel-heading" role="tab" id="headingFour">-->
						<!--<h4 class="panel-title">-->
							<!--<a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseFour" aria-expanded="false" aria-controls="collapseFour">-->
								<!--<span>Available imports</span>-->
							<!--</a>-->
						<!--</h4>-->
					<!--</div>-->
					<!--<div id="collapseFour" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingFour">-->
						<!--<div class="panel-body">-->
							<!--<div class="form-group margin-top-style" >-->
								<!--<button class="btn btn-default margin-left-style remove-border"><img height="20" width="20" src="/api/images/trip-advisor.png"> TripAdvisor</button>-->
								<!--<hr class="margin-left-style margin-right-style remove-element-top-bot-spaces">-->
								<!--<button class="btn btn-default margin-left-style remove-border"><img height="20" width="20" src="/api/images/openStreetMap.png"> OpenStreetMap</button>-->
								<!--<hr class="margin-left-style margin-right-style remove-element-top-bot-spaces">-->
								<!--<button class="btn btn-default margin-left-style remove-border"><img height="20" width="20" src="/api/images/wikipedia.png"> Wikipedia</button>-->
							<!--</div>-->
						<!--</div>-->
					<!--</div>-->
				<!--</div>-->
				<!--<div class="panel panel-default">-->
					<!--<div class="panel-heading" role="tab" id="headingFive">-->
						<!--<h4 class="panel-title">-->
							<!--<a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseFive" aria-expanded="false" aria-controls="collapseFive">-->
								<!--<span>Similar object</span>-->
							<!--</a>-->
						<!--</h4>-->
					<!--</div>-->
					<!--<div id="collapseFive" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingFive">-->
						<!--<div class="panel-body">-->
							<!--<div class="form-group margin-left-style margin-right-style margin-bottom-style">-->
								<!--<div class="card">-->
									<!--<div class="card-body">-->
										<!--<div class="col-md-8 padding-left-0px">-->
											<!--<h2 did="placeName" class="remove-element-top-bot-spaces">Pyzata hata</h2>-->
											<!--<p did="placeType">Restoran</p>-->
											<!--<p><b>id:</b> <a did="placeId" href="">23dfd</a></p>-->
											<!--<p did="placeLocation">12.2323,12.43445</p>-->
											<!--<br>-->
											<!--<button class="btn btn-default">Merge</button>-->
										<!--</div>-->
										<!--<div class="col-md-4">-->
											<!--<img height="100" width="100" src="/api/images/trip-advisor.png">-->
										<!--</div>-->
									<!--</div>-->
								<!--</div>-->
							<!--</div>-->
						<!--</div>-->
					<!--</div>-->
				<!--</div>-->
			</div>
		</div>

		<div class="table-responsive custom-table display-none">
			<table class="table table-bordered browse-tag-list" id="tag-table">
				<tbody id="main-bot-table">
				</tbody>
			</table>
		</div>
		<div class="panel-body display-none">
			<div class="form-group">
				<div class="input-group">
					<span class="input-group-btn">
						<span class="btn btn-default btn-file">
							Browse<input type="file" id="image-file">
						</span>
					</span>
					<input type="text" class="form-control" readonly>
				</div>
				<img id='img-upload display-none'/>
			</div>
			<div class="form-group hidden" id="result-hash">
				<p>Result: <b><span id="result-add-image"></span></b></p>
			</div>
			<div class="form-group">
				<input type="submit" value="Add File" id="add-file-btn" class="btn btn-primary form-control">
			</div>
		</div>
	</div>

	<div id='map-header' class="form-row align-items-center">
		<div class="col-2 group-inline margin-top-style-5">
			<input class="form-control d-none" type="date" id="date-filter">
			<select id="filter" class="form-control d-none">
				<option selected value="all">Filter...</option>
			</select>
		</div>
		<div class="col-2">
			<span id='map-header-text'></span>
		</div>
		<div class="col-8 group-inline">
			<nav class="nav right-float">
				<ul>
					<li class="my_account">
						<a href="/profile/edit/" id="account_name">My account</a>
					</li>
					<li class="avatar_my_account"><a href="/accounts/logout/"><img src="/static/dist/images/avatar-default.92d4a989ea4d.png"></a></li>
				</ul>
			</nav>
		</div>
	</div>
	<div id='map'>
	</div>
<!-- https://github.com/makinacorpus/Leaflet.RestoreView/blob/master/leaflet.restoreview.js -->
<script>
		(function() {
		var RestoreViewMixin = {
			restoreView: function () {
				if (!storageAvailable('localStorage')) {
					return false;
				}
				var storage = window.localStorage;
				if (!this.__initRestore) {
					this.on('moveend', function (e) {
						if (!this._loaded)
							return;  // Never access map bounds if view is not set.

						var view = {
							lat: this.getCenter().lat,
							lng: this.getCenter().lng,
							zoom: this.getZoom()
						};
						storage['mapView'] = JSON.stringify(view);
					}, this);
					this.__initRestore = true;
				}

				var view = storage['mapView'];
				try {
					view = JSON.parse(view || '');
					this.setView(L.latLng(view.lat, view.lng), view.zoom, true);
					return true;
				}
				catch (err) {
					return false;
				}
			}
		};

		function storageAvailable(type) {
			try {
				var storage = window[type],
					x = '__storage_test__';
				storage.setItem(x, x);
				storage.removeItem(x);
				return true;
			}
			catch(e) {
				console.warn("Your browser blocks access to " + type);
				return false;
			}
		}

		L.Map.include(RestoreViewMixin);
	})();
</script>

<script>
    var map = L.map('map');
	var currentLayer = null;
	var currentBounds = {};
	var placesCache = {};
	var mapInvalidate = true;
	var coloredMarkers = {};
	var tileBased = false;

	function calculateLocationCodes(bounds) {
		var tl = OpenLocationCode.encode(bounds.getNorth(), bounds.getWest(), 6);
		var rb = OpenLocationCode.encode(bounds.getSouth(), bounds.getEast(), 6);
		var INT_PR = 20;
		var tllat = Math.ceil(bounds.getNorth() * INT_PR);
		var tllon = Math.floor(bounds.getWest() * INT_PR);
		var brlat = Math.floor(bounds.getSouth() * INT_PR);
		var brlon = Math.ceil(bounds.getEast() * INT_PR);
		var mp = {};
		for (var lat = tllat; lat > brlat; lat --) {
			for (var lon = tllon; lon < brlon; lon ++) {
				var clat = (lat - 0.5) / INT_PR ;
				var clon = (lon + 0.5) / INT_PR ;
				var tileId = OpenLocationCode.encode(clat, clon, 6).substring(0, 6);
				mp[tileId] = {};
			}
		}
		return mp;
	}

	function gcPlaceTiles() {
		var toDel = {};
		if(Object.keys(placesCache).length < 150) {
			return;
		}
		for(var k in placesCache) {
			if(!(k in currentBounds)) {
				toDel[k] = placesCache[k].access;
			}
		}
		for(var k in toDel) {
			delete placesCache[k];
		}
	}

	function refreshMapDelay() {
		mapInvalidate = true;
		setTimeout(function() {
			if(mapInvalidate) {
				mapInvalidate = false;
				refreshMap();
			}
		}, 500);
	}

	function getMarkerContent(feature) {
		var p = feature.properties;
		var popupContent = p.title;
		if(p.opr_id) {
			popupContent += " (" + p.opr_id+") ";
		}
		if(p.tags) {
			for (var t in p.tags) {
				popupContent += "<br>" + t + " " + p.tags[t];
			}
		}
		if(p.opr_id) {
			popupContent += "<br><a href=\'/api/admin?view=objects&browse=type&type=opr.place&subtype=id&key=" +
				p.opr_id + "\'>OpenPlaceReviews</a>";
		}
		if(p.osm_id) {
			popupContent += "<br><a href=\'https://www.openstreetmap.org/" +
				p.osm_type + "/" + p.osm_id + "\'>OpenStreetMap</a>";
		}
		return popupContent;
	}

	var addClickListener = false;
	function refreshData(params="") {
		$("#map-header-text").text("Loading data...");
		$.getJSON("data?"+params, function (mp) {
			let data = mp.geo;
			placesCache[""] = { data: data };
			if("date" in mp.parameters) {
				$("#date-filter").removeClass("d-none");
			}
			if(mp.tileBased) {
				tileBased = true;
				onMapChange();
			}
			if(mp.placeTypes) {
				var filter = $("#filter");
				filter.empty();
                addClickListener = true;
				filter.append(new Option("Filter...", "all"));
				for (var type in mp.placeTypes) {
					filter.append(new Option(mp.placeTypes[type], type));
				}
				filter.removeClass("d-none");
				$("#filter").change(function(){
					refreshMapDelay();
				});
			}
			refreshMapDelay();
		});
	}

	function refreshMap() {
		var msg =  "Loading data...";
		if (currentLayer) {
			map.removeLayer(currentLayer);
			// currentLayer.remove();
		}
		var geoJson = {
			"type":"FeatureCollection",
			"features":[]
		};
		if (tileBased) {
			var tiles = 0;
			var missing = 0;
			var filterVal = $("#filter").val();
			for (var k in currentBounds) {
				var cTileId = placesCache[k];
				if (cTileId.data && "features" in cTileId.data) {
					tiles++;
					if (filterVal == "all") {
						geoJson.features = geoJson.features.concat(cTileId.data.features);
					} else {
						for (var i = 0; i < cTileId.data.features.length; i++) {
							var f = cTileId.data.features[i];
							if (f.properties && f.properties.place_type == filterVal) {
								geoJson.features.push(f);
							}
						}
					}
				} else {
					missing++;
				}
			}
			msg = tiles + " tiles have " + geoJson.features.length + " places ";
			if (missing > 0) {
				msg += " (" + missing + " tiles loading...) ";
			}
		} else {
			geoJson = placesCache[""].data;
			msg = "Loaded " + geoJson.features.length + " places";
		}
		$("#map-header-text").text(msg);
		currentLayer = L.markerClusterGroup();
		let currentLayerPoints = L.geoJSON(geoJson , {
			style: function (feature) {
				return feature.properties && feature.properties.style;
			},

			pointToLayer: function (feature, latlng) {
				var iconVal = {};
				if ('color' in feature.properties && feature.properties.color in coloredMarkers) {
					iconVal = { icon: coloredMarkers[feature.properties.color] };
				}
				var marker = L.marker(latlng, iconVal);
				if (addClickListener) {
                    return marker.on('click', function () {addClickMenuInfo(feature)} );
				} else {
                    return marker.bindPopup(getMarkerContent(feature));
				}
				function addClickMenuInfo(feature) {
                    openNav();
                    var prop = feature.properties;
                    $("#placeName").html(prop.title);
                    $("#placeType").html(prop.subtitle);
                    $("#placeId").html(prop.opr_id).attr("href", "/api/admin?view=objects&browse=type&limit=50&type=opr.place&subtype=id&key=" + prop.opr_id);
                    $("#placeLocation").html(showLocationCoordinates(feature.geometry.coordinates));

                    var table = $("#osm-tag-table");
                    table.empty();
                    var template = $("#tag-template");
                    var tripadvisorExist = false;
                    if (prop.sources) {
                        for (var i = 0; i < prop.sources.length; i++) {
                            var placeObj = prop.sources[i];
                            if (placeObj.source_type === "osm") {
                                $("#osmTagsAmount").html(Object.keys(placeObj.tags).length);
                                $("#osmId").html(placeObj.id).attr("href", "https://www.openstreetmap.org/" + placeObj.type + "/" + placeObj.id);
                                $("#osmVersion").html(placeObj.version);
                                $("#placeChangeset").html("#" + placeObj.changeset).attr("href", "https://www.openstreetmap.org/changeset/" + placeObj.changeset);

                                var objTag = placeObj.tags;
                                for (var tag in objTag) {
                                    let newTemplate = template.clone()
                                        .appendTo(table)
                                        .removeClass("hidden")
                                        .show();

                                    fillTemplateFields(newTemplate, tag, objTag[tag]);
                                }
                            } else if (placeObj.source_type === "tripadvisor" || placeObj.source_type === "tripAdvisor") {
                                tripadvisorExist = true;
                                var tripadvisorObj = placeObj.id;
                                $("#tripadvisorId").html(generateTripAdvisorId(tripadvisorObj)).attr("href", "https://www.tripadvisor.com/" + generateTripAdvisorId(tripadvisorObj))
							}
						}

                    }
                    if (!tripadvisorExist) {
                        $("#missing-tripadvisor").removeClass("hidden");
                        $("#tripadvisor-link").html("https://www.google.com/search?q=site:tripadvisor.com%20" + prop.title).attr("href", "https://www.google.com/search?q=site:tripadvisor.com%20" + prop.title);
					}
                    $("#osmLocation").html(showLocationCoordinates(feature.geometry.coordinates));

                    var opendbTable = $("#opendb-tag-table");
                    opendbTable.empty();
                    var imgTemplate = $("#img-tag-template");

                    if (prop.tags) {
                        for (var t in prop.tags) {
                            var obj = prop.tags[t];
                            let newTemplate = imgTemplate.clone()
                                .appendTo(opendbTable)
                                .removeClass("hidden")
                                .show();

                            newTemplate.find("[did='tag-k']").html(t).attr("href", "https://wiki.openstreetmap.org/wiki/Uk:Key:" + t + "?uselang=uk");
                            newTemplate.find("[did='tag-v']").html(obj.value);
                            switch (obj.source) {
								case "osm": {
                                    newTemplate.find("[did='image-tag-k']").attr("src", "/api/images/openStreetMap.png");
                                }
                            }
						}
					}
                }
				// return L.circleMarker(latlng, {
				// 	radius: 8,
				// 	fillColor: "#ff7800",
				// 	color: "#000",
				// 	weight: 1,
				// 	opacity: 1,
				// 	fillOpacity: 0.8
				// });
			}
		});
		currentLayer.addLayer(currentLayerPoints);
		// currentLayer.addTo(map);
		map.addLayer(currentLayer);
		gcPlaceTiles();
	}

	function generateTripAdvisorId(id) {
		return id[0] + "-" + id[1];
    }

	function onMapChange() {
		var bounds = map.getBounds();
		var lcodes = calculateLocationCodes(bounds);
		if(map.getZoom() <= 10) {
			$("#map-header-text").text("zooming to get data ");
		} else if(JSON.stringify(lcodes) != JSON.stringify(currentBounds) ) {
			currentBounds = lcodes;
			var tilesToLoad = {};
			for(var t in lcodes) {
				let tileId = t;
				if(!placesCache[tileId]) {
					placesCache[tileId] = { "access": 1 };
					// on failure we can clear cache
					$.getJSON("data?tileid=" + tileId, function (mp) {
						let data = mp.geo;
						placesCache[tileId].data = data;
						refreshMapDelay();
					});
				} else {
					placesCache[tileId].access = placesCache[tileId].access + 1;
				}
			}
			refreshMapDelay();
		}
	}

	function initColoredMarkers() {
		coloredMarkers = { "green": {}, "blue": {}, "red": {} };
		for (var clr in coloredMarkers) {
			coloredMarkers[clr] =
				new L.Icon({
					iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-' + clr + '.png',
					shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
					iconSize: [25, 41],
					iconAnchor: [12, 41],
					popupAnchor: [1, -34],
					shadowSize: [41, 41]
				});
		}
	}

	function showLocationCoordinates(coordinates) {
	    return coordinates[0] + ", " + coordinates[1];
	}

	initColoredMarkers();


	if (!map.restoreView()) {
        map.setView([40, -35], 4);
	}
	L.tileLayer('https://tile.osmand.net/{z}/{x}/{y}.png', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ',
		id: 'tiles'
	}).addTo(map);

	map.on('moveend', function (e) {
		if(tileBased) {
			onMapChange();	
		}
	});
	refreshData();
	$("#date-filter").change(function(){
		refreshData("date=" + $("#date-filter").val());
	});

    $(document).ready(function () {
        sidenavReady();
	});

</script>


</body>
</html>